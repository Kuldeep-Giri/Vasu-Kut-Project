import{b as m}from"./chunk-CUJCW6GI.js";import{M as p,a as c}from"./chunk-YDDR5VUJ.js";import{Q as l,T as h,Y as i,c as n,g}from"./chunk-ZCWZLXOA.js";var d=class a{constructor(t,e){this.http=t;this.authService=e;this.loadCartFromStorage()}apiUrl=`${m.apiBaseUrl}/cart`;localCartKey="guestCart";cartLengthSubject=new g(0);cartLength$=this.cartLengthSubject.asObservable();loadCartFromStorage(){let t=localStorage.getItem("cartLength");this.cartLengthSubject.next(t?parseInt(t,10):0)}isUserLoggedIn(){return!!localStorage.getItem("token")}getUserId(){let t=localStorage.getItem("token");return t?this.authService.getLoggedInUserId(t):""}addToCart(t,e){let s={productId:t,quantity:e,userId:this.getUserId()};if(this.isUserLoggedIn())this.http.post(`${this.apiUrl}/add`,s).subscribe(()=>this.getCartItemsLength(),r=>console.error("Error adding to cart",r));else{let r=JSON.parse(localStorage.getItem(this.localCartKey)||"[]"),o=r.find(u=>u.productId===t);o?o.quantity+=e:r.push(s),localStorage.setItem(this.localCartKey,JSON.stringify(r)),this.updateCartLength(r.length)}}getCart(){return this.isUserLoggedIn()?this.http.get(`${this.apiUrl}/get/${this.getUserId()}`):new n(t=>{t.next(JSON.parse(localStorage.getItem(this.localCartKey)||"[]")),t.complete()})}updateCartLength(t){this.cartLengthSubject.next(t),localStorage.setItem("cartLength",t.toString())}getCartItemsLength(){if(this.isUserLoggedIn())this.http.get(`${this.apiUrl}/get/${this.getUserId()}`).subscribe(t=>this.updateCartLength(t.length),t=>console.error("Error fetching cart length",t));else{let t=JSON.parse(localStorage.getItem(this.localCartKey)||"[]");this.updateCartLength(t.length)}}mergeCart(){if(this.isUserLoggedIn()){let t=JSON.parse(localStorage.getItem(this.localCartKey)||"[]");t.length>0&&this.http.post(`${this.apiUrl}/merge?userId=${this.getUserId()}`,t).subscribe(()=>{localStorage.removeItem(this.localCartKey),this.getCartItemsLength()},e=>console.error("Error merging guest cart",e))}}removeCartItem(t){return this.http.delete(`${this.apiUrl}/remove/${t}`).pipe(l(()=>this.getCartItemsLength()))}clearCart(){this.isUserLoggedIn()?this.http.delete(`${this.apiUrl}/clear/${this.getUserId()}`).subscribe(()=>this.updateCartLength(0),t=>console.error("Error clearing cart",t)):(localStorage.removeItem(this.localCartKey),this.updateCartLength(0))}static \u0275fac=function(e){return new(e||a)(i(c),i(p))};static \u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})};export{d as a};
